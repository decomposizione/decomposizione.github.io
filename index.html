<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLL Pendulum - Educational Simulation</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1 id="main-title">Phase-Locked Loop Pendulum Simulator</h1>
            <div class="language-toggle">
                <button id="lang-it" class="lang-btn active">IT</button>
                <button id="lang-en" class="lang-btn">EN</button>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Sidebar with Controls -->
            <aside class="controls-panel">
                <h2 id="controls-title">Controls</h2>
                
                <div class="control-group info-display">
                    <label id="label-freq-display">
                        Natural Frequency (Hz)
                        <span class="info-icon" title="Calculated from pendulum length: f = √(g/L)/(2π)">ⓘ</span>
                    </label>
                    <span id="value-freq-display" class="value-display-readonly">0.407 Hz</span>
                </div>

                <div class="control-group info-display">
                    <label id="label-amplitude-display">
                        Current Amplitude (degrees)
                        <span class="info-icon" title="Resulting amplitude from energy impulse and Q factor">ⓘ</span>
                    </label>
                    <span id="value-amplitude-display" class="value-display-readonly">0.01°</span>
                </div>

                <div class="control-group">
                    <label for="pll-gain" id="label-gain">
                        PLL Loop Gain
                        <span class="info-icon" title="How fast the PLL locks to the signal">ⓘ</span>
                    </label>
                    <input type="range" id="pll-gain" min="0.1" max="5.0" step="0.1" value="1.0">
                    <span id="value-gain" class="value-display">1.00</span>
                </div>

                <div class="control-group">
                    <label for="q-factor" id="label-q">
                        Quality Factor Q
                        <span class="info-icon" title="Oscillator quality factor (higher = less damping)">ⓘ</span>
                    </label>
                    <input type="range" id="q-factor" min="2" max="7" step="0.1" value="3">
                    <span id="value-q" class="value-display">1000</span>
                </div>

                <div class="control-group">
                    <label for="lunar-freq" id="label-lunar">
                        Lunar Modulation Frequency
                        <span class="info-icon" title="Frequency of tidal modulation (M2 component)">ⓘ</span>
                    </label>
                    <input type="range" id="lunar-freq" min="-3.7" max="-1" step="0.01" value="-2.65">
                    <span id="value-lunar" class="value-display">22.3 µHz</span>
                </div>

                <div class="control-group">
                    <label for="sim-speed" id="label-sim-speed">
                        Simulation Speed
                        <span class="info-icon" title="Speed multiplier for simulation (1x = real-time)">ⓘ</span>
                    </label>
                    <input type="range" id="sim-speed" min="0" max="3" step="0.01" value="0">
                    <span id="value-sim-speed" class="value-display">1x</span>
                </div>

                <div class="control-group">
                    <label for="spectrum-center" id="label-spectrum-center">
                        Pendulum Spectrum Center (Hz)
                        <span class="info-icon" title="Center frequency for pendulum spectrum analysis">ⓘ</span>
                    </label>
                    <input type="range" id="spectrum-center" min="0.1" max="5.0" step="0.1" value="1.5">
                    <span id="value-spectrum-center" class="value-display">1.5 Hz</span>
                </div>

                <div class="control-group">
                    <label for="tidal-spectrum-center" id="label-tidal-spectrum-center">
                        Tidal Spectrum Center (µHz)
                        <span class="info-icon" title="Center frequency for tidal spectrum analysis">ⓘ</span>
                    </label>
                    <input type="range" id="tidal-spectrum-center" min="-3" max="-0.5" step="0.01" value="-2.65">
                    <span id="value-tidal-spectrum-center" class="value-display">22.3 µHz</span>
                </div>

                <div class="control-group">
                    <label for="pendulum-length" id="label-length">
                        Pendulum Length (cm)
                        <span class="info-icon" title="Length of the pendulum rod">ⓘ</span>
                    </label>
                    <input type="range" id="pendulum-length" min="50" max="200" step="1" value="150">
                    <span id="value-length" class="value-display">150 cm</span>
                </div>

                <div class="control-group">
                    <label for="pendulum-mass" id="label-mass">
                        Pendulum Mass (kg)
                        <span class="info-icon" title="Mass of the pendulum bob">ⓘ</span>
                    </label>
                    <input type="range" id="pendulum-mass" min="1" max="10" step="0.1" value="1.0">
                    <span id="value-mass" class="value-display">1.0 kg</span>
                </div>

                <div class="control-group">
                    <label for="energy-impulse" id="label-energy">
                        Energy Impulse at Zero
                        <span class="info-icon" title="Energy added when pendulum passes through zero position">ⓘ</span>
                    </label>
                    <input type="range" id="energy-impulse" min="-9" max="0.7" step="0.01" value="-3">
                    <span id="value-energy" class="value-display">1 mJ</span>
                </div>

                <div class="button-group">
                    <button id="btn-reset" class="btn btn-primary">Reset Simulation</button>
                    <button id="btn-pause" class="btn btn-secondary">Pause</button>
                </div>

                <div class="pll-status">
                    <h3 id="status-title">PLL Status</h3>
                    <div class="status-indicator">
                        <span id="lock-status" class="status-label">Acquiring...</span>
                        <div class="lock-led" id="lock-led"></div>
                    </div>
                </div>
            </aside>

            <!-- Main Visualization Area -->
            <section class="main-content">
                <div class="canvas-container">
                    <div id="p5-canvas"></div>
                </div>

                <!-- Graphs Panel -->
                <div class="graphs-container">
                    <div class="graph-panel">
                        <canvas id="phase-error-graph"></canvas>
                        <p id="graph-phase-label" class="graph-label">Phase Error Over Time</p>
                    </div>
                    <div class="graph-panel">
                        <canvas id="frequency-graph"></canvas>
                        <p id="graph-freq-label" class="graph-label">PLL Locked Frequency</p>
                    </div>
                    <div class="graph-panel graph-panel-wide">
                        <canvas id="spectrum-graph"></canvas>
                        <p id="graph-spectrum-label" class="graph-label">Pendulum Spectrum (0-3 Hz)</p>
                    </div>
                    <div class="graph-panel graph-panel-wide">
                        <canvas id="tidal-spectrum-graph"></canvas>
                        <p id="graph-tidal-spectrum-label" class="graph-label">Tidal Frequency Spectrum (20-25 µHz)</p>
                    </div>
                    <div class="graph-panel graph-panel-wide">
                        <canvas id="tidal-phase-graph"></canvas>
                        <p id="graph-tidal-phase-label" class="graph-label">Tidal Frequency Phase (20-25 µHz)</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Educational Info Panel -->
        <section class="info-panel">
            <h2 id="info-title">About Phase-Locked Loops and Tidal Frequencies</h2>
            <div class="info-content" id="info-content">
                <p>
                    A Phase-Locked Loop (PLL) is a control system that generates an output signal whose phase is related to the phase of an input signal. 
                    In this simulation, the pendulum represents a natural oscillator (like tidal forces), and the PLL attempts to lock onto its frequency.
                </p>
                <h3>How it works:</h3>
                <ul>
                    <li><strong>Phase Detector:</strong> Compares the pendulum's phase with the VCO output</li>
                    <li><strong>Loop Filter:</strong> Smooths the phase error signal</li>
                    <li><strong>VCO:</strong> Adjusts its frequency based on the filtered error</li>
                </ul>
                <h3>Application to Tidal Analysis:</h3>
                <p>
                    Tidal frequencies are extremely stable and can be measured using PLL techniques. The main tidal constituents 
                    (M2, S2, K1, O1) have known periods, and PLLs can extract these specific frequency components from noisy tidal gauge data.
                </p>
            </div>
        </section>

        <!-- System Representation and Formulas -->
        <section class="system-panel">
            <h2 id="system-title">System Representation & Mathematical Model</h2>
            
            <div class="system-diagram">
                <h3 id="pll-diagram-title">Phase-Locked Loop Block Diagram</h3>
                <div class="diagram-box">
                    <svg viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- Input Signal -->
                        <text x="10" y="105" font-size="14" fill="#2c3e50">θ_in(t)</text>
                        <line x1="60" y1="100" x2="100" y2="100" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <!-- Phase Detector -->
                        <rect x="100" y="70" width="120" height="60" fill="#3498db" stroke="#2c3e50" stroke-width="2" rx="5"/>
                        <text x="160" y="95" font-size="12" fill="white" text-anchor="middle">Phase</text>
                        <text x="160" y="110" font-size="12" fill="white" text-anchor="middle">Detector</text>
                        <circle cx="160" cy="130" r="15" fill="white" stroke="#2c3e50" stroke-width="2"/>
                        <line x1="150" y1="130" x2="170" y2="130" stroke="#2c3e50" stroke-width="2"/>
                        <line x1="160" y1="120" x2="160" y2="140" stroke="#2c3e50" stroke-width="2"/>
                        
                        <!-- Error Signal -->
                        <line x1="220" y1="100" x2="270" y2="100" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="245" y="90" font-size="11" fill="#e74c3c">ε(t)</text>
                        
                        <!-- Loop Filter -->
                        <rect x="270" y="70" width="120" height="60" fill="#9b59b6" stroke="#2c3e50" stroke-width="2" rx="5"/>
                        <text x="330" y="95" font-size="12" fill="white" text-anchor="middle">Loop Filter</text>
                        <text x="330" y="110" font-size="12" fill="white" text-anchor="middle">(PI)</text>
                        
                        <!-- Control Voltage -->
                        <line x1="390" y1="100" x2="440" y2="100" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="415" y="90" font-size="11" fill="#27ae60">v_c(t)</text>
                        
                        <!-- VCO -->
                        <rect x="440" y="70" width="120" height="60" fill="#e67e22" stroke="#2c3e50" stroke-width="2" rx="5"/>
                        <text x="500" y="95" font-size="12" fill="white" text-anchor="middle">VCO</text>
                        <text x="500" y="110" font-size="12" fill="white" text-anchor="middle">(ω = ω₀ + K·v_c)</text>
                        
                        <!-- Output -->
                        <line x1="560" y1="100" x2="610" y2="100" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="620" y="105" font-size="14" fill="#2c3e50">θ_out(t)</text>
                        
                        <!-- Feedback -->
                        <line x1="580" y1="100" x2="580" y2="150" stroke="#2c3e50" stroke-width="2"/>
                        <line x1="580" y1="150" x2="160" y2="150" stroke="#2c3e50" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <!-- Arrow marker definition -->
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#2c3e50" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>

            <div class="formulas-section">
                <h3 id="formulas-title">Mathematical Formulas</h3>
                
                <div class="formula-group">
                    <h4 id="pendulum-eq-title">1. Damped Pendulum Equation</h4>
                    <div class="formula-box">
                        <p class="formula">
                            d²θ/dt² + 2ζω₀(dθ/dt) + ω₀² sin(θ) = 0
                        </p>
                        <p class="formula-desc" id="pendulum-desc">
                            Where: ζ = 1/(2Q) is damping ratio, ω₀ = 2πf₀ is natural angular frequency, Q is quality factor
                        </p>
                    </div>
                </div>

                <div class="formula-group">
                    <h4 id="tidal-mod-title">2. Tidal Modulation</h4>
                    <div class="formula-box">
                        <p class="formula">
                            ω(t) = ω₀ [1 + Σ A_i sin(2πf_tidal,i · t)]
                        </p>
                        <p class="formula-desc" id="tidal-desc">
                            Frequency modulated by tidal components: M2 (22.34 µHz), S2 (23.15 µHz), K1 (11.61 µHz), O1 (11.38 µHz)
                        </p>
                    </div>
                </div>

                <div class="formula-group">
                    <h4 id="phase-det-title">3. Phase Detector</h4>
                    <div class="formula-box">
                        <p class="formula">
                            ε(t) = θ_in(t) - θ_out(t)  [wrapped to [-π, π]]
                        </p>
                        <p class="formula-desc" id="phase-det-desc">
                            Measures phase difference between input and VCO output
                        </p>
                    </div>
                </div>

                <div class="formula-group">
                    <h4 id="loop-filter-title">4. Loop Filter (PI Controller)</h4>
                    <div class="formula-box">
                        <p class="formula">
                            v_c(t) = K_p · ε(t) + K_i · ∫ε(τ)dτ
                        </p>
                        <p class="formula-desc" id="loop-filter-desc">
                            K_p = loop gain (proportional), K_i = integral gain. Provides Type-2 loop for zero steady-state error.
                        </p>
                    </div>
                </div>

                <div class="formula-group">
                    <h4 id="vco-title">5. Voltage Controlled Oscillator</h4>
                    <div class="formula-box">
                        <p class="formula">
                            dθ_out/dt = ω₀ + K_VCO · v_c(t)
                        </p>
                        <p class="formula-desc" id="vco-desc">
                            VCO frequency adjusts based on control voltage. K_VCO is the VCO gain (Hz/V).
                        </p>
                    </div>
                </div>

                <div class="formula-group">
                    <h4 id="lock-condition-title">6. Lock Condition</h4>
                    <div class="formula-box">
                        <p class="formula">
                            |ε(t)| &lt; ε_threshold  for  t &gt; t_lock
                        </p>
                        <p class="formula-desc" id="lock-desc">
                            PLL is considered locked when phase error remains below threshold (0.3 rad) for sufficient time.
                        </p>
                    </div>
                </div>

                <div class="formula-group">
                    <h4 id="quality-factor-title">7. Quality Factor</h4>
                    <div class="formula-box">
                        <p class="formula">
                            Q = ω₀/(2ζω₀) = 1/(2ζ) = f₀/Δf
                        </p>
                        <p class="formula-desc" id="quality-desc">
                            Higher Q means lower damping and longer oscillations. For tidal measurements, Q can be 10⁶ or higher.
                        </p>
                    </div>
                </div>

                <div class="formula-group">
                    <h4 id="tidal-freqs-title">8. Tidal Frequencies</h4>
                    <div class="formula-box">
                        <table class="tidal-table">
                            <tr>
                                <th>Component</th>
                                <th>Frequency (µHz)</th>
                                <th>Period (hours)</th>
                                <th>Origin</th>
                            </tr>
                            <tr>
                                <td><strong>M2</strong></td>
                                <td>22.344</td>
                                <td>12.42</td>
                                <td id="m2-origin">Principal lunar semidiurnal</td>
                            </tr>
                            <tr>
                                <td><strong>S2</strong></td>
                                <td>23.148</td>
                                <td>12.00</td>
                                <td id="s2-origin">Principal solar semidiurnal</td>
                            </tr>
                            <tr>
                                <td><strong>K1</strong></td>
                                <td>11.607</td>
                                <td>23.93</td>
                                <td id="k1-origin">Lunisolar diurnal</td>
                            </tr>
                            <tr>
                                <td><strong>O1</strong></td>
                                <td>11.381</td>
                                <td>25.82</td>
                                <td id="o1-origin">Lunar diurnal</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p id="footer-text">Educational simulation for understanding Phase-Locked Loops | Built with p5.js</p>
    </footer>

    <script src="i18n.js"></script>
    <script src="pll.js"></script>
    <script src="ui.js"></script>
    <script src="sketch.js"></script>
</body>
</html>

